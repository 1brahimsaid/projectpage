// const global.options = require('../global.options')
const lib = require('./lib')
const page = require('./page')
const express = require('express')
const http = require('http')
const reload = require('reload')
const chokidar = require('chokidar')
var nodeCleanup = require('node-cleanup')
const { prototype } = require('inquirer/lib/objects/choices')

var server = {
    start: () => {
        const app = express()

        var port = global.options.port
        app.use(express.static(global.options.siteFolder))

        // 404 handling.
        // app.get('*', (req, res) => {
        //     // res.send('404', 404)
        //     res.redirect('/404')
        // })

        // var server = http.createServer(app)

        if (global.options.dev) {
            // Reload code here
            var server = http.createServer(app)

            // Reload code here
            reload(app).then(function (reloadReturned) {
                // reloadReturned is documented in the returns API in the README
                var watcher = chokidar.watch()
                watcher.add([
                    global.options.siteFolder,
                ])
                watcher.on('change', (path) => {
                    reloadReturned.reload()
                })
                nodeCleanup(function (exitCode, signal) {
                    console.log('ded')
                    reloadReturned.closeServer()
                    // release resources here before node exits
                })

                // Reload started, start web server
                function runServer(port) {
                    server.listen(port)
                    console.log(`Development server listening on port http://localhost:${port}.`.brightBlue)
                }
                runServer(port)

                server.once('error', function (err) {
                    if (err.code === 'EADDRINUSE') {
                        console.log(`Port ${port} is taken.`.brightRed)
                        runServer(port + 1)
                    }
                })
            }).catch(function (err) {
                console.error('Reload could not start, could not start server/sample app', err)
            })

            // changes in pages
            var watcher = chokidar.watch()
            watcher.add([
                global.options.pagesFolder,
            ])
            watcher.on('change', (path) => {
                // console.log('Live Preview:'.brightYellow + (' http://localhost:' + server.address().port).blue)
                page.parseRoute(path, (route) => {
                    page.compile(route, () => { })
                })
            })

            // changes in template
            var watcher = chokidar.watch()
            watcher.add([
                global.options.templateFolder,
            ])
            watcher.on('change', (path) => {
                // console.log('Live Preview:'.brightYellow + (' http://localhost:' + server.address().port).blue)
                lib.build()
            })

            // changes in the `public` folder
            var publicWatcher = chokidar.watch()
            publicWatcher.add([
                global.options.publicFolder,
            ])
            publicWatcher.on('change', (path) => {
                page.syncPublic(() => { })
                page.syncStylesheet(() => { })
            })
        } else {
            app.listen(port, () => {
                // console.log(`Production server running on: http://localhost:${port}`)
            })
        }
    }
}

module.exports = server
